name: WIP Release Python SDK

permissions:
  contents: read
  id-token: write

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Pre-release label (e.g. alpha, beta, rc)'
        required: true
        default: 'beta'
      branch:
        description: 'Branch containing the WIP changes'
        required: true
        default: 'main'

jobs:
  wip-release:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/python/iii

    steps:
      - name: Warning
        working-directory: .
        run: |
          echo "WARNING: WIP Release bypasses the approval gate"
          echo "This workflow should only be used for testing purposes"
          echo "For production releases, use the Create Tag workflow instead"
          echo ""
          echo "Publishing pre-release with label: ${{ github.event.inputs.tag }}"
          echo "From branch: ${{ github.event.inputs.branch }}"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tools
        run: pip install build

      - name: Get current version
        id: current_version
        run: |
          CURRENT=$(grep '^version = ' pyproject.toml | head -n1 | cut -d'"' -f2)
          echo "Current version: $CURRENT"
          echo "version=$CURRENT" >> $GITHUB_OUTPUT

      - name: Set pre-release version
        id: version
        run: |
          TAG="${{ github.event.inputs.tag }}"
          CURRENT="${{ steps.current_version.outputs.version }}"
          BASE_VERSION=$(echo "$CURRENT" | cut -d'a' -f1 | cut -d'b' -f1 | cut -d'r' -f1)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          
          case "$TAG" in
            alpha) NEW_VERSION="${BASE_VERSION}a${TIMESTAMP}" ;;
            beta)  NEW_VERSION="${BASE_VERSION}b${TIMESTAMP}" ;;
            rc)    NEW_VERSION="${BASE_VERSION}rc${TIMESTAMP}" ;;
            *)     NEW_VERSION="${BASE_VERSION}.dev${TIMESTAMP}" ;;
          esac
          
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" pyproject.toml
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Show version information
        working-directory: .
        run: |
          echo "### Version Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** iii-sdk" >> $GITHUB_STEP_SUMMARY
          echo "- **Current version:** ${{ steps.current_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **New version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release label:** ${{ github.event.inputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install iii-sdk==${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Build package
        run: python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: packages/python/iii/dist/
          password: ${{ secrets.PYPI_API_TOKEN }}
