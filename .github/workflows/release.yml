name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  notify-start:
    name: Initialize Slack Notification
    runs-on: ubuntu-latest
    outputs:
      slack_ts: ${{ steps.slack.outputs.ts }}
    
    steps:
      - name: Post initial Slack message
        id: slack
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "üöÄ Release ${{ github.ref_name }} started"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Release ${{ github.ref_name }}* üöÄ\n\n‚è≥ Running tests...\n‚¨ú Creating release...\n‚¨ú Building binaries (0/9)\n‚¨ú Validating release..."
              - type: "context"
                elements:
                  - type: "mrkdwn"
                    text: "Triggered by ${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"

      - name: Save Slack timestamp to artifact
        run: |
          mkdir -p slack-data
          echo "${{ steps.slack.outputs.ts }}" > slack-data/message_ts.txt
          echo "${{ github.ref_name }}" > slack-data/version.txt

      - name: Upload Slack data
        uses: actions/upload-artifact@v4
        with:
          name: slack-notification-data
          path: slack-data/
          retention-days: 1

  test:
    name: Run Tests
    needs: notify-start
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry & build
        uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: cargo test --all-features

      - name: Download Slack data
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: slack-notification-data
          path: slack-data/

      - name: Update Slack - Tests Complete
        if: success()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.update
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            ts: ${{ needs.notify-start.outputs.slack_ts }}
            text: "üöÄ Release ${{ github.ref_name }} in progress"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Release ${{ github.ref_name }}* üöÄ\n\n‚úÖ Tests passed\n‚è≥ Creating release...\n‚¨ú Building binaries (0/9)\n‚¨ú Validating release..."
              - type: "context"
                elements:
                  - type: "mrkdwn"
                    text: "Triggered by ${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"

      - name: Update Slack - Tests Failed
        if: failure()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.update
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            ts: ${{ needs.notify-start.outputs.slack_ts }}
            text: "‚ùå Release ${{ github.ref_name }} failed"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Release ${{ github.ref_name }}* ‚ùå\n\n‚ùå Tests failed\n‚¨ú Creating release...\n‚¨ú Building binaries (0/9)\n‚¨ú Validating release..."
              - type: "context"
                elements:
                  - type: "mrkdwn"
                    text: "Triggered by ${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"

  create-release:
    name: Create Release
    needs: [notify-start, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.MOTIA_CI_APP_ID }}
          private-key: ${{ secrets.MOTIA_CI_APP_PRIVATE_KEY }}
          permission-contents: write

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ steps.generate_token.outputs.token }}
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Update Slack - Release Created
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.update
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            ts: ${{ needs.notify-start.outputs.slack_ts }}
            text: "üöÄ Release ${{ github.ref_name }} in progress"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Release ${{ github.ref_name }}* üöÄ\n\n‚úÖ Tests passed\n‚úÖ Release created\n‚è≥ Building binaries (0/9)\n‚¨ú Validating release..."
              - type: "context"
                elements:
                  - type: "mrkdwn"
                    text: "Triggered by ${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}|View Release>"

  build-release:
    name: Build Release Binaries
    needs: [notify-start, create-release]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-pc-windows-msvc
            os: windows-latest
          - target: i686-pc-windows-msvc
            os: windows-latest
          - target: aarch64-pc-windows-msvc
            os: windows-latest
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          - target: armv7-unknown-linux-gnueabihf
            os: ubuntu-latest

    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.MOTIA_CI_APP_ID }}
          private-key: ${{ secrets.MOTIA_CI_APP_PRIVATE_KEY }}
          permission-contents: write

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate_token.outputs.token }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry & build
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Build and upload binary
        uses: taiki-e/upload-rust-binary-action@v1
        with:
          bin: iii
          target: ${{ matrix.target }}
          tar: unix
          zip: windows
          token: ${{ steps.generate_token.outputs.token }}

  notify-builds-complete:
    name: Update Build Status
    needs: [notify-start, build-release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check build results
        id: check_builds
        run: |
          RESULT='${{ needs.build-release.result }}'
          echo "Build result: $RESULT"
          
          if [ "$RESULT" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "count=9" >> $GITHUB_OUTPUT
            echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
          else
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "count=partial" >> $GITHUB_OUTPUT
            echo "emoji=‚ö†Ô∏è" >> $GITHUB_OUTPUT
          fi

      - name: Update Slack - Builds Complete
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.update
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            ts: ${{ needs.notify-start.outputs.slack_ts }}
            text: "${{ steps.check_builds.outputs.emoji }} Release ${{ github.ref_name }} builds complete"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Release ${{ github.ref_name }}* üöÄ\n\n‚úÖ Tests passed\n‚úÖ Release created\n${{ steps.check_builds.outputs.emoji }} Binaries built (${{ steps.check_builds.outputs.count }}/9)\n‚è≥ Validating release..."
              - type: "context"
                elements:
                  - type: "mrkdwn"
                    text: "Triggered by ${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}|View Release>"

