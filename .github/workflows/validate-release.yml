name: Validate Release

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed

env:
  CARGO_TERM_COLOR: always
  GH_TOKEN: ${{ github.token }}

permissions:
  contents: write
  actions: read

jobs:
  validate:
    name: Validate Release Artifacts
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get release tag
        id: get_tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$TAG" ]; then
            echo "No tag found, skipping validation"
            exit 0
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Validating release: $TAG"

      - name: Download Slack notification data
        id: download_slack
        continue-on-error: true
        run: |
          echo "Attempting to download artifact from workflow run ${{ github.event.workflow_run.id }}"
          
          # List artifacts for the workflow run
          ARTIFACTS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts")
          
          echo "Available artifacts:"
          echo "$ARTIFACTS" | jq -r '.artifacts[] | .name'
          
          # Find the slack-notification-data artifact
          ARTIFACT_ID=$(echo "$ARTIFACTS" | jq -r '.artifacts[] | select(.name=="slack-notification-data") | .id')
          
          if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" == "null" ]; then
            echo "No slack-notification-data artifact found"
            exit 0
          fi
          
          echo "Found artifact ID: $ARTIFACT_ID"
          
          # Download the artifact
          mkdir -p slack-data
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" > artifact.zip
          
          # Extract the artifact
          unzip -q artifact.zip -d slack-data/
          
          echo "Artifact downloaded successfully"
          ls -la slack-data/

      - name: Get Slack message timestamp
        id: get_slack_ts
        run: |
          if [ -f "slack-data/message_ts.txt" ]; then
            SLACK_TS=$(cat slack-data/message_ts.txt)
            echo "slack_ts=$SLACK_TS" >> $GITHUB_OUTPUT
            echo "has_slack_ts=true" >> $GITHUB_OUTPUT
            echo "Found Slack timestamp: $SLACK_TS"
          else
            echo "has_slack_ts=false" >> $GITHUB_OUTPUT
            echo "No Slack timestamp found, will send new message"
          fi

      - name: Download release assets
        run: |
          TAG="${{ steps.get_tag.outputs.tag }}"
          if [ -z "$TAG" ]; then
            exit 0
          fi
          
          echo "Downloading assets for release $TAG"
          mkdir -p release-assets
          cd release-assets
          
          gh release download "$TAG" || {
            echo "Failed to download release assets"
            exit 1
          }
          
          ls -lh

      - name: Validate all platforms present
        id: validate_platforms
        run: |
          TAG="${{ steps.get_tag.outputs.tag }}"
          if [ -z "$TAG" ]; then
            exit 0
          fi
          
          EXPECTED_PLATFORMS=(
            "x86_64-apple-darwin"
            "aarch64-apple-darwin"
            "x86_64-pc-windows-msvc"
            "i686-pc-windows-msvc"
            "aarch64-pc-windows-msvc"
            "x86_64-unknown-linux-gnu"
            "x86_64-unknown-linux-musl"
            "aarch64-unknown-linux-gnu"
            "armv7-unknown-linux-gnueabihf"
          )
          
          MISSING_PLATFORMS=()
          
          for platform in "${EXPECTED_PLATFORMS[@]}"; do
            if [[ "$platform" == *"windows"* ]]; then
              FILE="release-assets/iii-${platform}.zip"
            else
              FILE="release-assets/iii-${platform}.tar.gz"
            fi
            
            if [ ! -f "$FILE" ]; then
              echo "‚ùå Missing: $FILE"
              MISSING_PLATFORMS+=("$platform")
            else
              echo "‚úÖ Found: $FILE"
              SIZE=$(stat -f%z "$FILE" 2>/dev/null || stat -c%s "$FILE" 2>/dev/null)
              if [ "$SIZE" -lt 100000 ]; then
                echo "‚ö†Ô∏è  Warning: $FILE is suspiciously small ($SIZE bytes)"
                MISSING_PLATFORMS+=("$platform (too small)")
              fi
            fi
          done
          
          if [ ${#MISSING_PLATFORMS[@]} -gt 0 ]; then
            echo "validation_failed=true" >> $GITHUB_OUTPUT
            echo "missing_platforms=${MISSING_PLATFORMS[*]}" >> $GITHUB_OUTPUT
            echo ""
            echo "‚ùå Validation FAILED - Missing or invalid platforms:"
            printf '%s\n' "${MISSING_PLATFORMS[@]}"
            exit 1
          else
            echo "validation_failed=false" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úÖ All platforms validated successfully"
          fi

      - name: Update Slack - Validation Success
        if: success() && steps.get_slack_ts.outputs.has_slack_ts == 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.update
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            ts: ${{ steps.get_slack_ts.outputs.slack_ts }}
            text: "‚úÖ Release ${{ steps.get_tag.outputs.tag }} completed successfully"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Release ${{ steps.get_tag.outputs.tag }}* ‚úÖ\n\n‚úÖ Tests passed\n‚úÖ Release created\n‚úÖ Binaries built (9/9)\n‚úÖ Validation passed"
              - type: "actions"
                elements:
                  - type: "button"
                    text:
                      type: "plain_text"
                      text: "üì¶ Download Release"
                    url: "${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.get_tag.outputs.tag }}"
                    style: "primary"
              - type: "context"
                elements:
                  - type: "mrkdwn"
                    text: "Release completed successfully"

      - name: Notify Slack - Validation Success (Fallback)
        if: success() && steps.get_slack_ts.outputs.has_slack_ts != 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "‚úÖ Release ${{ steps.get_tag.outputs.tag }} validated successfully"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Release Validated* ‚úÖ\nVersion: `${{ steps.get_tag.outputs.tag }}`\nAll 9 platform binaries present and valid"
              - type: "actions"
                elements:
                  - type: "button"
                    text:
                      type: "plain_text"
                      text: "üì¶ Download Release"
                    url: "${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.get_tag.outputs.tag }}"
                    style: "primary"

      - name: Update Slack - Validation Failed
        if: failure() && steps.get_slack_ts.outputs.has_slack_ts == 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.update
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            ts: ${{ steps.get_slack_ts.outputs.slack_ts }}
            text: "‚ùå Release ${{ steps.get_tag.outputs.tag }} failed validation"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Release ${{ steps.get_tag.outputs.tag }}* ‚ùå\n\n‚úÖ Tests passed\n‚úÖ Release created\n‚ö†Ô∏è Binaries built (partial)\n‚ùå Validation failed\n\nMissing platforms: ${{ steps.validate_platforms.outputs.missing_platforms }}\n\n‚ö†Ô∏è *Auto-rollback will be initiated*"
              - type: "context"
                elements:
                  - type: "mrkdwn"
                    text: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"

      - name: Notify Slack - Validation Failed (Fallback)
        if: failure() && steps.get_slack_ts.outputs.has_slack_ts != 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "‚ùå Release validation failed for ${{ steps.get_tag.outputs.tag }}"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Release Validation Failed* ‚ùå\nVersion: `${{ steps.get_tag.outputs.tag }}`\nMissing platforms: ${{ steps.validate_platforms.outputs.missing_platforms }}\n\n‚ö†Ô∏è *Auto-rollback will be initiated*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"

      - name: Trigger auto-rollback
        if: failure() && steps.validate_platforms.outputs.validation_failed == 'true'
        run: |
          TAG="${{ steps.get_tag.outputs.tag }}"
          
          PREVIOUS_TAG=$(git tag -l "v*" | sort -V | grep -B1 "^${TAG}$" | head -n1)
          
          if [ -z "$PREVIOUS_TAG" ] || [ "$PREVIOUS_TAG" == "$TAG" ]; then
            echo "No previous version found for rollback"
            exit 1
          fi
          
          echo "Triggering rollback from $TAG to $PREVIOUS_TAG"
          
          gh workflow run rollback.yml \
            -f target_version="$PREVIOUS_TAG" \
            -f reason="Auto-rollback: Release validation failed - missing platforms: ${{ steps.validate_platforms.outputs.missing_platforms }}" \
            -f delete_bad_release=true

      - name: Summary
        if: always()
        run: |
          TAG="${{ steps.get_tag.outputs.tag }}"
          echo "### Release Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** \`$TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validate_platforms.outputs.validation_failed }}" == "true" ]; then
            echo "‚ùå **Status:** FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Missing Platforms:**" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validate_platforms.outputs.missing_platforms }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Auto-rollback has been triggered" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Status:** SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All 9 platform binaries validated successfully" >> $GITHUB_STEP_SUMMARY
          fi

  publish-sdk:
    name: Publish Node SDK
    needs: validate
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get release tag
        id: get_tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$TAG" ]; then
            echo "No tag found, skipping SDK publishing"
            exit 0
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Publishing SDK for release: $TAG"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: |
          cd packages/node/iii
          pnpm install

      - name: Build SDK
        run: |
          cd packages/node/iii
          pnpm build

      - name: Publish to npm
        id: publish
        run: |
          cd packages/node/iii
          pnpm publish --access restricted --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Notify Slack - SDK Published
        if: success()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "üì¶ Node SDK published for release ${{ steps.get_tag.outputs.tag }}"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Node SDK Published* üì¶\n\nVersion: `${{ steps.get_tag.outputs.tag }}`\nPackage: `@iii-dev/sdk`\n\n‚úÖ Published to npm registry"
              - type: "context"
                elements:
                  - type: "mrkdwn"
                    text: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"

      - name: Notify Slack - SDK Publishing Failed
        if: failure()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "‚ö†Ô∏è Node SDK publishing failed for release ${{ steps.get_tag.outputs.tag }}"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*SDK Publishing Failed* ‚ö†Ô∏è\n\nVersion: `${{ steps.get_tag.outputs.tag }}`\nPackage: `@iii-dev/sdk`\n\n‚ùå Failed to publish to npm registry\n\n‚ö†Ô∏è Release binaries are available but SDK was not published"
              - type: "context"
                elements:
                  - type: "mrkdwn"
                    text: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"

      - name: Summary
        if: always()
        run: |
          TAG="${{ steps.get_tag.outputs.tag }}"
          echo "### Node SDK Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** \`$TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.publish.outcome }}" == "success" ]; then
            echo "‚úÖ **Status:** Published successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Package \`@iii-dev/sdk@$TAG\` is now available on npm" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status:** Publishing failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Release binaries are available but SDK was not published" >> $GITHUB_STEP_SUMMARY
          fi
