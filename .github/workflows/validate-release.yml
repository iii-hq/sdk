name: Validate Release

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed

env:
  GH_TOKEN: ${{ github.token }}

permissions:
  contents: write
  actions: read

jobs:
  validate:
    name: Validate Release Artifacts
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get release tag
        id: get_tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$TAG" ]; then
            echo "No tag found, skipping validation"
            exit 0
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Validating release: $TAG"

      - name: Download Slack notification data
        id: download_slack
        continue-on-error: true
        run: |
          ARTIFACTS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts")
          
          ARTIFACT_ID=$(echo "$ARTIFACTS" | jq -r '.artifacts[] | select(.name=="slack-notification-data") | .id')
          
          if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" == "null" ]; then
            echo "No slack-notification-data artifact found"
            exit 0
          fi
          
          mkdir -p slack-data
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" > artifact.zip
          
          unzip -q artifact.zip -d slack-data/

      - name: Get Slack message timestamp
        id: get_slack_ts
        run: |
          if [ -f "slack-data/message_ts.txt" ]; then
            SLACK_TS=$(cat slack-data/message_ts.txt)
            echo "slack_ts=$SLACK_TS" >> $GITHUB_OUTPUT
            echo "has_slack_ts=true" >> $GITHUB_OUTPUT
          else
            echo "has_slack_ts=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate Node SDK on npm
        id: validate_node
        continue-on-error: true
        run: |
          VERSION="${{ steps.get_tag.outputs.version }}"
          if [ -z "$VERSION" ]; then exit 0; fi
          
          for i in 1 2 3 4 5; do
            if npm view "iii-sdk@$VERSION" version 2>/dev/null; then
              echo "node_ok=true" >> $GITHUB_OUTPUT
              echo "Node SDK $VERSION found on npm"
              exit 0
            fi
            echo "Attempt $i: not yet available, waiting 30s..."
            sleep 30
          done
          
          echo "node_ok=false" >> $GITHUB_OUTPUT
          echo "Node SDK $VERSION not found on npm after retries"

      - name: Validate Python SDK on PyPI
        id: validate_python
        continue-on-error: true
        run: |
          VERSION="${{ steps.get_tag.outputs.version }}"
          if [ -z "$VERSION" ]; then exit 0; fi
          
          for i in 1 2 3 4 5; do
            if pip index versions iii-sdk 2>/dev/null | grep -q "$VERSION"; then
              echo "python_ok=true" >> $GITHUB_OUTPUT
              echo "Python SDK $VERSION found on PyPI"
              exit 0
            fi
            echo "Attempt $i: not yet available, waiting 30s..."
            sleep 30
          done
          
          echo "python_ok=false" >> $GITHUB_OUTPUT
          echo "Python SDK $VERSION not found on PyPI after retries"

      - name: Validate Rust SDK on crates.io
        id: validate_rust
        continue-on-error: true
        run: |
          VERSION="${{ steps.get_tag.outputs.version }}"
          if [ -z "$VERSION" ]; then exit 0; fi
          
          for i in 1 2 3 4 5; do
            RESPONSE=$(curl -s "https://crates.io/api/v1/crates/iii-sdk/$VERSION")
            if echo "$RESPONSE" | jq -e '.version.num' 2>/dev/null | grep -q "$VERSION"; then
              echo "rust_ok=true" >> $GITHUB_OUTPUT
              echo "Rust SDK $VERSION found on crates.io"
              exit 0
            fi
            echo "Attempt $i: not yet available, waiting 30s..."
            sleep 30
          done
          
          echo "rust_ok=false" >> $GITHUB_OUTPUT
          echo "Rust SDK $VERSION not found on crates.io after retries"

      - name: Update Slack - Validation Success
        if: steps.get_slack_ts.outputs.has_slack_ts == 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.update
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            ts: ${{ steps.get_slack_ts.outputs.slack_ts }}
            text: "Release ${{ steps.get_tag.outputs.tag }} validated"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Release ${{ steps.get_tag.outputs.tag }}* :white_check_mark:\n\n:${{ steps.validate_node.outputs.node_ok == 'true' && 'white_check_mark' || 'warning' }}: Node SDK on npm\n:${{ steps.validate_python.outputs.python_ok == 'true' && 'white_check_mark' || 'warning' }}: Python SDK on PyPI\n:${{ steps.validate_rust.outputs.rust_ok == 'true' && 'white_check_mark' || 'warning' }}: Rust SDK on crates.io"
              - type: "actions"
                elements:
                  - type: "button"
                    text:
                      type: "plain_text"
                      text: "Download Release"
                    url: "${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.get_tag.outputs.tag }}"
                    style: "primary"

      - name: Summary
        if: always()
        run: |
          TAG="${{ steps.get_tag.outputs.tag }}"
          echo "### Release Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** \`$TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node SDK (npm) | ${{ steps.validate_node.outputs.node_ok == 'true' && 'OK' || 'NOT FOUND' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python SDK (PyPI) | ${{ steps.validate_python.outputs.python_ok == 'true' && 'OK' || 'NOT FOUND' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust SDK (crates.io) | ${{ steps.validate_rust.outputs.rust_ok == 'true' && 'OK' || 'NOT FOUND' }} |" >> $GITHUB_STEP_SUMMARY
